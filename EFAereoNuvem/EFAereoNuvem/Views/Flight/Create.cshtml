@model EFAereoNuvem.Models.Flight

@{
    ViewData["Title"] = "Novo Voo";
}

<div class="page-header-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="page-title">
                    <i class="bi bi-airplane-fill me-3"></i>Novo Voo
                </h1>
                <p class="page-subtitle">Preencha os dados abaixo para cadastrar um novo voo</p>
            </div>
            <div class="col-lg-4 text-end">
                <div class="floating">
                    <i class="bi bi-airplane" style="font-size: 6rem; color: white; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <div class="form-card card">
                <div class="card-body p-4">
                    <form asp-action="Create" method="post" id="flightForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4"></div>

                        <!-- Dados Básicos do Voo -->
                        <div class="mb-5">
                            <h5 class="form-section-title">
                                <i class="bi bi-info-circle me-2"></i>Informações do Voo
                            </h5>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label asp-for="CodeFlight" class="form-label">
                                        <i class="bi bi-qr-code me-2"></i>Código do Voo *
                                    </label>
                                    <input asp-for="CodeFlight" class="form-control" placeholder="Ex: AA1234" maxlength="10" />
                                    <span asp-validation-for="CodeFlight" class="text-danger small"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="TypeFlight" class="form-label">
                                        <i class="bi bi-tag me-2"></i>Tipo de Voo *
                                    </label>
                                    <select asp-for="TypeFlight" class="form-select" asp-items="Html.GetEnumSelectList<EFAereoNuvem.Models.Enum.TypeFlight>()">
                                        <option value="">Selecione...</option>
                                    </select>
                                    <span asp-validation-for="TypeFlight" class="text-danger small"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="AirplaneId" class="form-label">
                                        <i class="bi bi-airplane me-2"></i>Aeronave *
                                    </label>

                                    @if (ViewBag.Airplanes != null && ((SelectList)ViewBag.Airplanes).Any())
                                    {
                                        <select asp-for="AirplaneId" class="form-select" asp-items="ViewBag.Airplanes">
                                            <option value="">Selecione uma aeronave...</option>
                                        </select>
                                        <span asp-validation-for="AirplaneId" class="text-danger small"></span>
                                        <small class="text-muted">@(((SelectList)ViewBag.Airplanes).Count()) aeronaves disponíveis</small>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning p-2">
                                            <small>Nenhuma aeronave cadastrada. <a asp-controller="Airplane" asp-action="Create">Cadastre uma aeronave primeiro</a>.</small>
                                        </div>
                                        <select asp-for="AirplaneId" class="form-select" disabled>
                                            <option value="">Nenhuma aeronave disponível</option>
                                        </select>
                                    }
                                </div>
                            </div>

                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label asp-for="Origin" class="form-label">
                                        <i class="bi bi-geo-alt me-2"></i>Origem *
                                    </label>
                                    <input asp-for="Origin" class="form-control" placeholder="Ex: São Paulo (GRU)" maxlength="50" />
                                    <span asp-validation-for="Origin" class="text-danger small"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Destination" class="form-label">
                                        <i class="bi bi-geo me-2"></i>Destino *
                                    </label>
                                    <input asp-for="Destination" class="form-control" placeholder="Ex: Rio de Janeiro (GIG)" maxlength="50" />
                                    <span asp-validation-for="Destination" class="text-danger small"></span>
                                </div>
                            </div>

                            <div class="row g-3 mt-2">
                                <div class="col-md-3">
                                    <label asp-for="DateFlight" class="form-label">
                                        <i class="bi bi-calendar me-2"></i>Data *
                                    </label>
                                    <input asp-for="DateFlight" type="date" class="form-control" id="DateFlight" />
                                    <span asp-validation-for="DateFlight" class="text-danger small"></span>
                                </div>
                                <div class="col-md-3">
                                    <label asp-for="Departure" class="form-label">
                                        <i class="bi bi-clock me-2"></i>Partida *
                                    </label>
                                    <input asp-for="Departure" type="time" class="form-control" />
                                    <span asp-validation-for="Departure" class="text-danger small"></span>
                                </div>
                                <div class="col-md-3">
                                    <label asp-for="Arrival" class="form-label">
                                        <i class="bi bi-clock-history me-2"></i>Chegada *
                                    </label>
                                    <input asp-for="Arrival" type="time" class="form-control" />
                                    <span asp-validation-for="Arrival" class="text-danger small"></span>
                                </div>
                                <div class="col-md-3">
                                    <label asp-for="Duration" class="form-label">
                                        <i class="bi bi-hourglass me-2"></i>Duração (h) *
                                    </label>
                                    <input asp-for="Duration" type="number" step="0.1" class="form-control" placeholder="Ex: 1.5" />
                                    <span asp-validation-for="Duration" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Escalas -->
                        <div class="mb-5">
                            <h5 class="form-section-title">
                                <i class="bi bi-signpost me-2"></i>Escalas
                            </h5>

                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input asp-for="ExistScale" class="form-check-input" type="checkbox" id="existScale" />
                                    <label class="form-check-label fw-semibold" for="existScale" style="color: var(--primary);">
                                        Este voo possui escalas?
                                    </label>
                                </div>
                            </div>

                            <div id="scalesSection" style="display: none;">
                                <div class="alert alert-info-custom mb-4">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Adicione as escalas do voo em ordem cronológica.
                                </div>

                                <div id="scalesContainer"></div>

                                <button type="button" class="btn btn-add-scale" id="addScale">
                                    <i class="bi bi-plus-circle me-2"></i>Adicionar Escala
                                </button>
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="d-flex flex-wrap gap-3 justify-content-end pt-4 border-top">
                            <a asp-action="Index" class="btn btn-secondary-custom">
                                <i class="bi bi-x-circle me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary-custom">
                                <i class="bi bi-check-circle me-2"></i>Cadastrar Voo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para Escala -->
<template id="scaleTemplate">
    <div class="scale-item card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-signpost-split me-2"></i>Escala <span class="scale-number">1</span>
            </h6>
            <button type="button" class="btn btn-sm btn-outline-danger remove-scale">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Local *</label>
                    <input type="text" class="form-control scale-location" placeholder="Ex: Brasília (BSB)" maxlength="50" required />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Chegada *</label>
                    <input type="time" class="form-control scale-arrival" required />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Partida *</label>
                    <input type="time" class="form-control scale-departure" required />
                </div>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const existScaleCheckbox = document.getElementById('existScale');
            const scalesSection = document.getElementById('scalesSection');
            const scalesContainer = document.getElementById('scalesContainer');
            const addScaleButton = document.getElementById('addScale');
            const scaleTemplate = document.getElementById('scaleTemplate');
            const flightForm = document.getElementById('flightForm');

            let scaleCount = 0;

            // Toggle da seção de escalas
            existScaleCheckbox.addEventListener('change', function() {
                scalesSection.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    scalesContainer.innerHTML = '';
                    scaleCount = 0;
                }
            });

            // Adicionar escala
            addScaleButton.addEventListener('click', function() {
                scaleCount++;
                const scaleClone = scaleTemplate.content.cloneNode(true);
                const scaleItem = scaleClone.querySelector('.scale-item');
                const scaleNumber = scaleClone.querySelector('.scale-number');

                scaleNumber.textContent = scaleCount;
                scaleItem.dataset.scaleIndex = scaleCount - 1;

                // Remover escala
                scaleClone.querySelector('.remove-scale').addEventListener('click', function() {
                    scaleItem.remove();
                    updateScaleNumbers();
                });

                scalesContainer.appendChild(scaleClone);
            });

            function updateScaleNumbers() {
                const scaleItems = scalesContainer.querySelectorAll('.scale-item');
                scaleCount = scaleItems.length;
                scaleItems.forEach((item, index) => {
                    item.querySelector('.scale-number').textContent = index + 1;
                    item.dataset.scaleIndex = index;
                });
            }

                    flightForm.addEventListener('submit', function(e) {
            // Limpar inputs hidden anteriores
            document.querySelectorAll('input[name^="scales["]').forEach(input => input.remove());

            if (existScaleCheckbox.checked) {
                const scaleItems = scalesContainer.querySelectorAll('.scale-item');
                let hasErrors = false;

                scaleItems.forEach((item, index) => {
                    const location = item.querySelector('.scale-location').value;
                    const arrival = item.querySelector('.scale-arrival').value;
                    const departure = item.querySelector('.scale-departure').value;

                    // Validar campos obrigatórios
                    if (!location || !arrival || !departure) {
                        e.preventDefault();
                        alert('Preencha todos os campos da escala ' + (index + 1));
                        hasErrors = true;
                        return;
                    }

                    // Validar que chegada é antes da partida
                    if (arrival >= departure) {
                        e.preventDefault();
                        alert('A chegada deve ser anterior à partida na escala ' + (index + 1));
                        hasErrors = true;
                        return;
                    }

                    // Criar inputs hidden para as escalas
                    if (!hasErrors) {
                        createHiddenInput(`scales[${index}].Location`, location);

                        // Enviar apenas o tempo, o controller combinará com a data
                        createHiddenInput(`scales[${index}].Arrival`, arrival);
                        createHiddenInput(`scales[${index}].Departure`, departure);
                    }
                });

                if (hasErrors) {
                    return false;
                }
            }
        });

            function createHiddenInput(name, value) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                flightForm.appendChild(input);
            }

            // Data mínima = hoje
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('DateFlight').min = today;

            //  Auto-calcular duração
            document.querySelector('input[name="Departure"]').addEventListener('change', calculateDuration);
            document.querySelector('input[name="Arrival"]').addEventListener('change', calculateDuration);

            function calculateDuration() {
                const departure = document.querySelector('input[name="Departure"]').value;
                const arrival = document.querySelector('input[name="Arrival"]').value;

                if (departure && arrival) {
                    const [depHours, depMinutes] = departure.split(':').map(Number);
                    const [arrHours, arrMinutes] = arrival.split(':').map(Number);

                    let durationHours = arrHours - depHours;
                    let durationMinutes = arrMinutes - depMinutes;

                    if (durationMinutes < 0) {
                        durationHours--;
                        durationMinutes += 60;
                    }

                    const totalHours = durationHours + (durationMinutes / 60);

                    if (totalHours > 0) {
                        document.querySelector('input[name="Duration"]').value = totalHours.toFixed(1);
                    }
                }
            }
        });
    </script>
}